<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
	</head>

	<body>
		<script src="../../js/jquery-2.2.2.min.js "></script>
		<script src="../../js/mui.min.js "></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/update-teacher-message.js"></script>

		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">个人信息</h1>
		</header>
		<div class="mui-content">

			<div class="mui-card" style="margin-bottom: 10px;">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell mui-media">
						<a id="person_message">
							<img class="mui-media-object mui-pull-right" src="../../img/Avatar.jpg">
							<div class="mui-media-body" style="margin-top: 10px;">
								头像
							</div>
						</a>
					</li>
				</ul>
			</div>

			<div class="mui-card">
				<div class="mui-table-view">
					<div class="mui-table-view-cell">
						<span>姓名：</span>
						<span id="tname"></span>
					</div>
					<div class="mui-table-view-cell">
						<a onclick="changeMessage('sex')">
							<span>性别：</span>
							<span id="sex"></span>
						</a>
					</div>
					<div class="mui-table-view-cell">
						<a onclick="changeMessage('phone')">
							<span>电话：</span>
							<span id="phone"></span>
						</a>
					</div>
					<div class="mui-table-view-cell">
						<a onclick="changeMessage('position')">
							<span>职称：</span>
							<span id="position"></span>
						</a>
					</div>
					<div class="mui-table-view-cell">
						<a onclick="changeMessage('office')">
							<span>办公室：</span>
							<span id="office"></span>
						</a>
					</div>
					<div class="mui-table-view-cell">
						<a onclick="changeMessage('lab')">
							<span>实验室：</span>
							<span id="lab"></span>
						</a>
					</div>
					<div class="mui-table-view-cell ">
						<span>所带学生个数：</span>
						<span id="limit"></span>
					</div>
				</div>
			</div>

			<div class="mui-card">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">获奖情况：</a>
						<div class="mui-collapse-content">
							<textarea id="award" readonly="readonly" onclick="changeMessage('award')" name="" rows="5" cols=""></textarea>
						</div>
					</li>
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">课题：</a>
						<div class="mui-collapse-content">
							<textarea id="topic" readonly="readonly" onclick="changeMessage('topic')" name="" rows="5" cols=""></textarea>
						</div>
					</li>
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">教学方向：</a>
						<div class="mui-collapse-content">
							<textarea id="teachingDirection" readonly="readonly" onclick="changeMessage('teachingDirection')" name="" rows="5" cols=""></textarea>
						</div>
					</li>
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">研究方向：</a>
						<div class="mui-collapse-content">
							<textarea id="researchDirection" readonly="readonly" onclick="changeMessage('researchDirection')" name="" rows="5" cols=""></textarea>
						</div>
					</li>
				</ul>
			</div>

			<div class="mui-card">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">详细信息</a>
						<div class="mui-collapse-content">
							<div class="mui-table-view">
								<div class="mui-table-view-cell">
									<a onclick="changeMessage('tbirthday_year')">
										<span>出生日期：</span>
										<span id="tbirthday_year"></span>
									</a>
								</div>

								<div class="mui-table-view-cell">
									<a onclick="changeMessage('degree')">
										<span>学位：</span>
										<span id="degree"></span>
									</a>
								</div>
								<div class="mui-table-view-cell">
									<a onclick="changeMessage('graduateSchool')">
										<span>毕业学校：</span>
										<span id="graduateSchool"></span>
									</a>
								</div>
								<div class="mui-table-view-cell">
									<a onclick="changeMessage('graduateTime')">
										<span>毕业时间：</span>
										<span id="graduateTime"></span>
									</a>
								</div>
								<div class="mui-table-view-cell">
									<a onclick="changeMessage('workTime')">
										<span>工作时间：</span>
										<span id="workTime"></span>
									</a>
								</div>
							</div>
						</div>
					</li>
				</ul>
			</div>

		</div>
	</body>
	<script>
		var id;
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});
		(function($) {
			$.ready(function() {
				load();
				//setInterval("load() ",1000);//重复执行
			});
		}(mui));

		function load() {
			id = window.location.href.split("=")[1];
			mui.ajax('http://192.168.1.187:8080/Select-H5/teacher/getTeacherById', {
				data: {
					id: id,
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					$(" #tname ").text(data.T_NAME);
					if(data.T_SEX == 1) {
						$("#sex").text("女");
					} else {
						$("#sex").text("男");
					}
					$("#tbirthday_year ").text(data.T_BIRTHDAY);
					$("#topic ").text(data.TOPIC);
					$("#office ").text(data.OFFICE);
					$("#lab ").text(data.LAB);
					$("#phone ").text(data.PHONE);
					$("#position ").text(data.POSITION);
					$("#degree ").text(data.DEGREE);
					$("#graduateSchool ").text(data.GRADUATE_SCHOOL);
					$("#graduateTime ").text(data.GRADUATE_TIME);
					$("#workTime ").text(data.WORK_DATE);
					$("#award ").text(data.AWARD);
					$("#teachingDirection").text(data.TEACHING_DIRECTION);
					$("#researchDirection").text(data.RESEARCH_AREA);
					$("#limit").text(data.LIMIT);
				},
				error: function(xhr, type, errorThrown) {
					//异常处理；
					mui.toast("网络错误！ ");
				}
			});
		}

		function changeMessage(type) {
			switch(type) {
				case "sex":
					{
						setRadio(type);
						break;
					}
				case "tbirthday_year":
					{
						setDate(type);
						break;
					}
				case "graduateTime":
					{
						setDate(type);
						break;
					}
				case "workTime":
					{
						setDate(type);
						break;
					}
				case "topic":
					{
						/*var topic = $("#topic").text();
						setText(type, "课题", topic);*/
						var url = "change_message.html?id=" + id + "&type=" + type;
						location.href = url;
						break;
					}
				case "office":
					{
						var office = $("#office").text();
						setText(type, "办公室", office);
						break;
					}
				case "lab":
					{
						var lab = $("#lab").text();
						setText(type, "实验室", lab);
						break;
					}
				case "phone":
					{
						var phone = $("#phone").text();
						setText(type, "电话", phone);
						break;
					}
				case "degree":
					{
						setRadio(type);
						break;
					}
				case "position":
					{
						setRadio(type);
						break;
					}
				case "graduateSchool":
					{
						var graduateSchool = $("#graduateSchool").text();
						setText(type, "毕业学校", graduateSchool);
						break;
					}
				case "award":
					{
						//var award = $("#award").text();
						//setText(type, "获奖情况", award);
						var url = "change_message.html?id=" + id + "&type=" + type;
						location.href = url;
						break;
					}
				case "teachingDirection":
					{
						/*var teachingDirection = $("#teachingDirection").text();
						setText(type, "教学方向", teachingDirection);*/
						var url = "change_message.html?id=" + id + "&type=" + type;
						location.href = url;
						break;
					}
				case "researchDirection":
					{
						/*var researchDirection = $("#researchDirection").text();
						setText(type, "研究方向", researchDirection);*/
						var url = "change_message.html?id=" + id + "&type=" + type;
						location.href = url;
						break;
					}

			}

		}

		function setRadio(type) {
			var data;
			if(type == "sex") {
				data = [{ value: '1', text: '女' },
					{ value: '0', text: '男' }
				];
			}
			if(type == "position") {
				data = [{ value: 'lecturer', text: '讲师' },
					{ value: 'Associate_Professor', text: '副教授 ' },
					{ value: 'Professor', text: '教授' }
				];
			}
			if(type == "degree") {
				data = [{ value: 'Bachelor_degree', text: '学士' },
					{ value: 'master', text: '硕士 ' },
					{ value: 'doctor', text: '博士' }
				];
			}
			var picker = new mui.PopPicker();
			picker.setData(data);
			picker.show(function(selectItems) {
				if(type == "sex") {
					updateMessage(type, selectItems[0].value);
				} else {
					updateMessage(type, selectItems[0].text);
				}
			})
		}

		function setDate(type) {
			var dtpicker = new mui.DtPicker({
				type: "date", //设置日历初始视图模式 
				beginDate: new Date(1980, 01, 01), //设置开始日期 
				//endDate: new Date(2016, 04, 25), //设置结束日期 
				labels: ['年', '月', '日'], //设置默认标签区域提示语 
			});
			dtpicker.show(function(selectItems) {
				var date = selectItems.y.value + "-" + selectItems.m.value + "-" + selectItems.d.value;
				updateMessage(type, date);
			});
		}

		function setText(type, message, placeholder) {
			mui.prompt('请输入' + message + ":", placeholder, '修改' + message, ['取消', '确定'], function(e) {
				if(e.index == 1) {
					//确定按钮
					updateMessage(type, e.value);
				} else {
					//取消按钮
				}
			})
		}
		//点击头像
		$("#person_message").click(function() {
			if(mui.os.plus) {
				var a = [{
					title: "拍照"
				}, {
					title: "从手机相册选择"
				}];
				plus.nativeUI.actionSheet({
					title: "修改用户头像",
					cancel: "取消",
					buttons: a
				}, function(b) { /*actionSheet 按钮点击事件*/
					switch(b.index) {
						case 0:
							break;
						case 1:
							getImage(); /*拍照*/
							break;
						case 2:
							galleryImg(); /*打开相册*/
							break;
						default:
							break;
					}
				})
			}
		});

		//拍照 
		function getImage() {
			var c = plus.camera.getCamera();
			c.captureImage(function(e) {
				plus.io.resolveLocalFileSystemURL(e, function(entry) {
					var s = entry.toLocalURL() + "?version=" + new Date().getTime();
					uploadHead(s); /*上传图片*/
				}, function(e) {
					console.log("读取拍照文件错误：" + e.message);
				});
			}, function(s) {
				console.log("error" + s);
			}, {
				filename: "_doc/head.png"
			})
		}

		//本地相册选择 
		function galleryImg() {
			plus.gallery.pick(function(a) {
				plus.io.resolveLocalFileSystemURL(a, function(entry) {
					plus.io.resolveLocalFileSystemURL("_doc/", function(root) {
						root.getFile("head.png", {}, function(file) {
							//文件已存在 
							file.remove(function() {
								console.log("file remove success");
								entry.copyTo(root, 'head.png', function(e) {
										var e = e.fullPath + "?version=" + new Date().getTime();
										uploadHead(e); /*上传图片*/
										//变更大图预览的src 
										//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现 
									},
									function(e) {
										console.log('copy image fail:' + e.message);
									});
							}, function() {
								console.log("delete image fail:" + e.message);
							});
						}, function() {
							//文件不存在 
							entry.copyTo(root, 'head.png', function(e) {
									var path = e.fullPath + "?version=" + new Date().getTime();
									uploadHead(path); /*上传图片*/
								},
								function(e) {
									console.log('copy image fail:' + e.message);
								});
						});
					}, function(e) {
						console.log("get _www folder fail");
					})
				}, function(e) {
					console.log("读取拍照文件错误：" + e.message);
				});
			}, function(a) {}, {
				filter: "image"
			})
		};

		//上传头像图片 
		function uploadHead(imgPath) {
			console.log("imgPath = " + imgPath);
			mainImage.src = imgPath;
			mainImage.style.width = "60px";
			mainImage.style.height = "60px";

			var image = new Image();
			image.src = imgPath;
			image.onload = function() {
				var imgData = getBase64Image(image);
				/*在这里调用上传接口*/
				mui.ajax("http://192.168.1.187:8080/Select-H5/teacher/tea_img_upload", {
					data: {
						tid: id
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					success: function(data) {
						console.log('上传成功');
					},
					error: function(xhr, type, errorThrown) {
						mui.toast('网络异常，请稍后再试！');
					}
				});
			}
		}
		//将图片压缩转成base64 
		function getBase64Image(img) {
			var canvas = document.createElement("canvas");
			var width = img.width;
			var height = img.height;
			// calculate the width and height, constraining the proportions 
			if(width > height) {
				if(width > 100) {
					height = Math.round(height *= 100 / width);
					width = 100;
				}
			} else {
				if(height > 100) {
					width = Math.round(width *= 100 / height);
					height = 100;
				}
			}
			canvas.width = width; /*设置新的图片的宽度*/
			canvas.height = height; /*设置新的图片的长度*/
			var ctx = canvas.getContext("2d");
			ctx.drawImage(img, 0, 0, width, height); /*绘图*/
			var dataURL = canvas.toDataURL("image/png", 0.8);
			return dataURL.replace("data:image/png;base64,", "");
		}
	</script>

</html>