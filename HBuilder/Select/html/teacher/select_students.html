<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/jquery-2.2.2.min.js "></script>
		<script type="text/javascript">
			mui.init()
		</script>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">选择学生</h1>
			<button class="mui-pull-right mui-btn mui-btn-success" onclick="saveSelect()">提交</button>
		</header>
		<div class="mui-content">
			<div class="mui-card">
				<ul class='mui-table-view mui-input-group' id="students-list">

				</ul>
			</div>
		</div>
	</body>
	<script>
		var tid, li, limit;
		var select_result = [];
		var select_result_name = [];
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});
		(function($) {
			$.ready(function() {
				load();
				//setInterval("load() ",1000);//重复执行
			});
		}(mui));

		function GetQueryString(name) //获取url对应字段 
		{
			var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
			var r = window.location.search.substr(1).match(reg);
			if(r != null) return decodeURI(r[2]);
			return null;
		}

		function load() {

			tid = GetQueryString("tid");
			mui.ajax('http://192.168.1.187:8080/Select-H5/select/getSelectRoundStudent', {
				data: {
					round1: tid
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					for(var i = 0; i < data.length; i++) {
						li = "<li class='mui-table-view-cell mui-input-row mui-checkbox'>" +
							"<label>" + data[i].S_NAME + "</label><input id='checkbox_" + data[i].S_ID + "' name='checkbox' value='" + data[i].S_ID + "' sname='" + data[i].S_NAME + "' type='checkbox' >" +
							"</li>";
						$("#students-list").append(li);
					}
				},
				error: function(xhr, type, errorThrown) {
					//异常处理；
					mui.toast("网络错误！ ");
				}
			});

			//获取教师选择限制
			mui.ajax('http://192.168.1.187:8080/Select-H5/teacher/getTeacherById', {
				data: {
					id: tid
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					limit = data.LIMIT;
				},
				error: function(xhr, type, errorThrown) {
					//异常处理；
					mui.toast("网络错误！ ");
				}
			});
		}

		//获取选择
		mui('.mui-input-group').on('change', 'input', function() {
			var value = this.checked ? "true" : "false";
			if(value == "true") {
				select_result.push(this.value);
				select_result_name.push(this.getAttribute("sname"));
			} else {
				removeByValue(select_result, this.value);
				removeByValue(select_result_name, this.getAttribute("sname"));
			}
		});

		//数组删除指定值元素
		function removeByValue(arr, val) {
			for(var i = 0; i < arr.length; i++) {
				if(arr[i] == val) {
					arr.splice(i, 1);
					break;
				}
			}
		}

		function saveSelect() {
			if(select_result.length >= limit) {
				alert("您最多只能选择" + (limit - 1) + "个学生！");
				return;
			}

			var btnArray = ['否', '是'];
			var message = "您确认选择: " + select_result_name + "?";
			mui.confirm(message, '确认选择', btnArray, function(e) {
				if(e.index == 1) {
					//alert("是")
					saveData(select_result);
				} else {
					//alert("否");
				}
			});
		}

		function saveData(select_result) {
			var result_data = "";
			for (var i=0; i<select_result.length;i++) {
				if(i == select_result.length-1){
					result_data += select_result[i];
				}else{
					result_data += select_result[i]+",";
				}
			}
			//保存选择
			mui.ajax('http://192.168.1.187:8080/Select-H5/select/saveSelectResult', {
				data: {
					result: result_data,
					tid: tid
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					mui.back();
				},
				error: function(xhr, type, errorThrown) {
					//异常处理；
					mui.toast("网络错误！ ");
				}
			});
		}
	</script>

</html>